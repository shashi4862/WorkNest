<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        html, body { height: 100%; }
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .dashboard-card { border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .table-rounded { border-radius: 10px; overflow: hidden; }
        .card-header { background-color: #e9ecef; border-bottom: none; font-weight: 600; color: #343a40; }
        .comment-box {
            background-color: #f0f2f5;
            border-radius: 10px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .comment-author {
            font-weight: bold;
            color: #0d6efd;
        }
        .input-group .form-control:focus {
            box-shadow: none;
        }
        .input-group .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
<div th:replace="fragments/header :: header"></div>

<main class="container mt-4 flex-grow-1">
    <h2 class="text-center mb-4 fw-bold text-primary">My Assigned Tasks</h2>

    <!-- Success/Error Message Display -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <!-- Assigned Tasks Table -->
    <div class="card dashboard-card">
        <div class="card-header fw-bold text-primary">My Tasks</div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-rounded">
                    <thead>
                    <tr>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Members</th>
                        <th>Update Status</th>
                        <th>Comments</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="a : ${assignments}">
                        <td>
                            <strong th:text="${a.task.title}"></strong>
                            <p class="mb-0" th:text="${a.task.description}"></p>
                        </td>
                        <td>
                            <span class="badge" th:classappend="${a.status == T(com.example.enums.TaskStatus).PENDING ? 'bg-info' :
                                                                  a.status == T(com.example.enums.TaskStatus).IN_PROGRESS ? 'bg-warning' :
                                                                  a.status == T(com.example.enums.TaskStatus).COMPLETED ? 'bg-success' :
                                                                  'bg-danger'}"
                                  th:text="${a.status}"></span>
                        </td>
                        <td>
                            <ul class="list-unstyled mb-0">
                                <li th:each="member : ${a.task.assignments}">
                                    <span th:text="${member.user.name}"></span>
                                    <span th:if="${member.isLeader}" class="badge bg-primary">Leader</span>
                                </li>
                            </ul>
                        </td>
                        <td>
                            <form th:action="@{/user/update-status}" method="post"
                                  th:if="${a.isLeader and !a.isLocked}">
                                <input type="hidden" name="assignmentId" th:value="${a.id}" />
                                <select name="status" class="form-select mb-1">
                                    <option th:each="status : ${T(com.example.enums.TaskStatus).values()}"
                                            th:value="${status}"
                                            th:text="${status}"
                                            th:selected="${a.status == status}">
                                    </option>
                                </select>
                                <button type="submit" class="btn btn-sm btn-success w-100">Update</button>
                            </form>
                            <span th:if="${!a.isLeader}" class="text-info fw-bold">Leader Only</span>
                            <span th:if="${a.isLocked}" class="text-danger fw-bold">Locked by Admin</span>
                        </td>
                        <td>
                            <!-- Comments List -->
                            <!-- NOTE: The backend must ensure that 'a.comments' contains ALL comments for the task -->
                            <div class="comment-box mb-2">
                                <div th:each="c : ${a.comments}" class="mb-1">
                                    <span class="comment-author" th:text="${c.author.name} + ': '"></span>
                                    <span th:text="${c.content}"></span>
                                </div>
                                <div th:if="${#lists.isEmpty(a.comments)}" class="text-muted">No comments yet.</div>
                            </div>
                            
                            <!-- Comment Form -->
                            <form th:action="@{/user/comment}" method="post">
                                <input type="hidden" name="assignmentId" th:value="${a.id}" />
                                <div class="input-group">
                                    <input type="text" name="content" class="form-control" placeholder="Add comment" required />
                                    <button type="submit" class="btn btn-primary">Add</button>
                                </div>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<div th:replace="fragments/footer :: footer" class="mt-auto"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
